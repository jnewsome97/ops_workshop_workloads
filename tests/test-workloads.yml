---
# Test playbook for ops_workshop_workloads collection
# Usage:
#   export KUBECONFIG=/path/to/kubeconfig
#   ansible-playbook -i localhost, -c local tests/test-workloads.yml
#
# To test specific workloads only:
#   ansible-playbook -i localhost, -c local tests/test-workloads.yml -e "test_workloads=['ocp4_workload_kubevirt']"
#
# To skip certain workloads:
#   ansible-playbook -i localhost, -c local tests/test-workloads.yml --skip-tags "showroom,rhdh"

- name: Test OpenShift Days Ops Track Workloads
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    # =========================================================================
    # REQUIRED: Set these before running
    # =========================================================================
    # Option 1: Set KUBECONFIG environment variable
    # Option 2: Provide these directly:
    # openshift_api_url: "https://api.cluster.example.com:6443"
    # openshift_api_key: "sha256~xxxxx"

    # =========================================================================
    # Mock AgnosticV variables
    # =========================================================================
    guid: "test1"
    ACTION: create
    silent: false

    # Common password (normally generated by AgnosticV)
    common_password: "TestPass123!"

    # AWS credentials - provide your own for full testing
    # Or leave empty to skip AWS-dependent workloads
    aws_region: "{{ lookup('env', 'AWS_DEFAULT_REGION') | default('us-east-2', true) }}"
    sandbox_aws_access_key_id: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') | default('', true) }}"
    sandbox_aws_secret_access_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') | default('', true) }}"

    # =========================================================================
    # Module flags - set to false to skip specific module workloads
    # =========================================================================
    module_enable_virt: true
    module_enable_acm: false        # ACM takes a long time, disabled by default
    module_enable_backup: false     # Requires ODF, disabled by default
    module_enable_devhub: true
    module_enable_ols: false        # Requires API token, disabled by default
    module_enable_security: false   # ACS takes a long time, disabled by default

    # =========================================================================
    # Workload configurations
    # =========================================================================

    # Catalog snapshot (for operator installations)
    ocp4_workload_catalogsource_image: quay.io/gpte-devops-automation/olm_snapshot_redhat_catalog
    ocp4_workload_catalogsource_tag: v4.20_2026_01_12

    # --- Cert Manager ---
    ocp4_workload_cert_manager_channel: stable-v1
    ocp4_workload_cert_manager_use_catalog_snapshot: true
    ocp4_workload_cert_manager_catalog_snapshot_image: "{{ ocp4_workload_catalogsource_image }}"
    ocp4_workload_cert_manager_catalog_snapshot_image_tag: "{{ ocp4_workload_catalogsource_tag }}"
    ocp4_workload_cert_manager_install_ingress_certificates: false
    ocp4_workload_cert_manager_install_api_certificates: false
    ocp4_workload_cert_manager_ignore_errors: true

    # --- OpenShift Virtualization ---
    ocp4_workload_kubevirt_channel: stable
    ocp4_workload_kubevirt_use_catalog_snapshot: true
    ocp4_workload_kubevirt_catalogsource_name: redhat-operators-snapshot-kubevirt
    ocp4_workload_kubevirt_catalog_snapshot_image: "{{ ocp4_workload_catalogsource_image }}"
    ocp4_workload_kubevirt_catalog_snapshot_image_tag: "{{ ocp4_workload_catalogsource_tag }}"
    ocp4_workload_kubevirt_deploy_hyperconverged: true
    ocp4_workload_kubevirt_install_virtctl: true
    ocp4_workload_kubevirt_enabled_nested_kvm: false
    ocp4_workload_kubevirt_boot_sources_snapshot: false

    # --- Pipelines ---
    ocp4_workload_pipelines_channel: latest
    ocp4_workload_pipelines_use_catalog_snapshot: false
    ocp4_workload_pipelines_install_tkn_cli: true

    # --- Web Terminal ---
    ocp4_workload_web_terminal_channel: fast
    ocp4_workload_web_terminal_use_catalog_snapshot: true
    ocp4_workload_web_terminal_catalogsource_name: redhat-operators-snapshot-web-terminal
    ocp4_workload_web_terminal_catalog_snapshot_image: "{{ ocp4_workload_catalogsource_image }}"
    ocp4_workload_web_terminal_catalog_snapshot_image_tag: "{{ ocp4_workload_catalogsource_tag }}"

    # --- GitOps ---
    ocp4_workload_openshift_gitops_channel: latest
    ocp4_workload_openshift_gitops_use_catalog_snapshot: false
    ocp4_workload_openshift_gitops_automatic_install_plan_approval: true
    ocp4_workload_openshift_gitops_setup_cluster_admin: true
    ocp4_workload_openshift_gitops_enable_route: true
    ocp4_workload_openshift_gitops_install_cli: true

    # --- Developer Hub ---
    ocp4_days_workload_rhdh_enable_guest_auth: true
    ocp4_days_workload_rhdh_channel: fast

    # =========================================================================
    # Workloads to test (override with -e to test specific ones)
    # =========================================================================
    test_workloads:
      # Foundation
      - agnosticd.core_workloads.ocp4_workload_cert_manager
      - agnosticd.core_workloads.ocp4_workload_pipelines
      - agnosticd.core_workloads.ocp4_workload_web_terminal
      # Virtualization (if enabled)
      - "{{ 'jnewsome97.ops_workshop_workloads.ocp4_workload_kubevirt' if module_enable_virt else '' }}"
      # Developer Hub (if enabled)
      - "{{ 'jnewsome97.ops_workshop_workloads.ocp4_days_workload_rhdh' if module_enable_devhub else '' }}"

  pre_tasks:
    - name: Verify cluster access
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Namespace
        name: default
      register: r_cluster_check

    - name: Display cluster info
      debug:
        msg: "Connected to cluster. Starting workload tests..."

    - name: Filter empty workloads from list
      set_fact:
        filtered_workloads: "{{ test_workloads | select | list }}"

    - name: Display workloads to test
      debug:
        msg: "Will test the following workloads: {{ filtered_workloads }}"

  tasks:
    - name: Run workloads
      include_role:
        name: "{{ workload_item }}"
      loop: "{{ filtered_workloads }}"
      loop_control:
        loop_var: workload_item
      when: workload_item | length > 0

  post_tasks:
    - name: Test complete
      debug:
        msg: |
          ============================================
          Workload testing complete!

          Tested workloads:
          {{ filtered_workloads | to_nice_yaml }}
          ============================================
